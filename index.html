<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Capture Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --navy:#0D2137; --blue:#1A3A5C; --teal:#2E86AB; --teal2:#4EAECB;
  --green:#1A9C5B; --red:#C0392B; --orange:#E67E22; --gold:#F0A500;
  --purple:#6C3483;
  --bg:#0A1628; --s1:#0F1E33; --s2:#162540; --s3:#1C2E4A;
  --border:#1E3550; --text:#E8F4F8; --muted:#7A9BB8; --dim:#3D6080;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(46,134,171,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(46,134,171,.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}

/* ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ */
#lockScreen{position:fixed;inset:0;background:linear-gradient(135deg,var(--navy) 0%,#071120 100%);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0}
.lock-card{background:var(--s1);border:1px solid var(--border);border-radius:24px;padding:44px 48px;width:420px;max-width:95vw;text-align:center;box-shadow:0 40px 100px rgba(0,0,0,.7);animation:fadeUp .5s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}}
.lock-logo{width:64px;height:64px;background:linear-gradient(135deg,var(--teal),var(--blue));border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 20px;box-shadow:0 0 30px rgba(46,134,171,.4)}
.lock-title{font-size:22px;font-weight:700;margin-bottom:6px}
.lock-subtitle{font-size:12px;color:var(--muted);margin-bottom:28px;font-family:'DM Mono',monospace}
.lock-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px 18px;color:var(--text);font-family:'DM Mono',monospace;font-size:16px;text-align:center;letter-spacing:4px;outline:none;transition:border-color .2s;margin-bottom:14px}
.lock-input:focus{border-color:var(--teal)}
.lock-btn{width:100%;padding:14px;border-radius:12px;background:linear-gradient(135deg,var(--teal),#1a6a8a);color:#fff;font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:14px;border:none;cursor:pointer;transition:all .2s;margin-bottom:10px}
.lock-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(46,134,171,.4)}
.lock-error{color:#E74C3C;font-size:12px;min-height:18px;font-family:'DM Mono',monospace;margin-top:4px}
.lock-hint{font-size:10px;color:var(--dim);margin-top:14px;font-family:'DM Mono',monospace}

/* ‚îÄ‚îÄ APP WRAPPER ‚îÄ‚îÄ */
#app{display:none;position:relative;z-index:1}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{background:linear-gradient(135deg,var(--navy) 0%,#0A1E35 100%);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;z-index:100;backdrop-filter:blur(20px)}
.tb-left{display:flex;align-items:center;gap:12px}
.logo-mark{width:36px;height:36px;background:linear-gradient(135deg,var(--teal),var(--blue));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;box-shadow:0 0 18px rgba(46,134,171,.4)}
.app-title{font-size:15px;font-weight:700;letter-spacing:-.3px}
.app-sub{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:1px}
.tb-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

/* filters */
.filter-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.filter-select{background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:11px;padding:6px 10px;outline:none;cursor:pointer;transition:border-color .2s}
.filter-select:focus{border-color:var(--teal)}
.filter-label{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;white-space:nowrap}

/* sync status */
.sync-pill{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;background:var(--s1);border:1px solid var(--border);padding:5px 10px;border-radius:20px}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--dim);transition:all .3s}
.sync-dot.live{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 2s infinite}
.sync-dot.loading{background:var(--gold);box-shadow:0 0 6px var(--gold);animation:pulse .5s infinite}
.sync-dot.err{background:var(--red);box-shadow:0 0 6px var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* buttons */
.btn{padding:7px 14px;border-radius:8px;font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:flex;align-items:center;gap:5px;white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--teal),#1a6a8a);color:#fff;box-shadow:0 2px 10px rgba(46,134,171,.3)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(46,134,171,.5)}
.btn-ghost{background:var(--s2);color:var(--muted);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--teal);color:var(--text)}
.btn-red{background:rgba(192,57,43,.15);color:#E74C3C;border:1px solid rgba(231,76,60,.3)}
.btn-red:hover{background:rgba(192,57,43,.25)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#c07800);color:#000;font-weight:700}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{padding:20px 24px;max-width:1440px;margin:0 auto}
.slabel{font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:10px;font-family:'DM Mono',monospace}

/* ‚îÄ‚îÄ MODE TOGGLE ‚îÄ‚îÄ */
.mode-bar{display:flex;align-items:center;gap:10px;margin-bottom:18px;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:6px 8px;width:fit-content}
.mode-btn{padding:7px 18px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;font-family:'Space Grotesk',sans-serif;background:transparent;color:var(--muted);transition:all .2s}
.mode-btn.active{background:var(--teal);color:#fff;box-shadow:0 2px 10px rgba(46,134,171,.4)}

/* ‚îÄ‚îÄ KPI GRID ‚îÄ‚îÄ */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:20px}
.kpi-card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px 18px;position:relative;overflow:hidden;transition:all .2s;cursor:default}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--ac,var(--teal))}
.kpi-card:hover{border-color:var(--teal);transform:translateY(-2px)}
.kpi-icon{font-size:18px;margin-bottom:6px}
.kpi-lbl{font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;font-family:'DM Mono',monospace}
.kpi-val{font-size:32px;font-weight:700;line-height:1;font-variant-numeric:tabular-nums;transition:all .4s}
.kpi-sub{font-size:10px;color:var(--muted);margin-top:5px}
.badge{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:600;padding:2px 7px;border-radius:20px;margin-top:6px}
.b-green{background:rgba(26,156,91,.15);color:#2ECC71;border:1px solid rgba(46,204,113,.3)}
.b-orange{background:rgba(230,126,34,.15);color:#E67E22;border:1px solid rgba(230,126,34,.3)}
.b-red{background:rgba(192,57,43,.15);color:#E74C3C;border:1px solid rgba(231,76,60,.3)}
.b-blue{background:rgba(46,134,171,.15);color:var(--teal2);border:1px solid rgba(46,134,171,.3)}
.b-gold{background:rgba(240,165,0,.15);color:var(--gold);border:1px solid rgba(240,165,0,.3)}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.prog-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;margin-bottom:20px}
.prog-card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:18px 20px}
.prog-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.prog-name{font-size:13px;font-weight:700}
.prog-sub{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px}
.prog-pct{font-size:26px;font-weight:700;font-variant-numeric:tabular-nums}
.prog-pct-lbl{font-size:9px;color:var(--muted);text-align:right;font-family:'DM Mono',monospace}
.track{background:var(--s3);height:8px;border-radius:8px;overflow:hidden;margin-bottom:8px}
.fill{height:100%;border-radius:8px;transition:width 1s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
.fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.prog-meta{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:12px}
.owner-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.owner-name{font-size:10px;color:var(--muted);width:90px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.owner-track{flex:1;background:var(--s3);height:5px;border-radius:5px;overflow:hidden}
.owner-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--teal),var(--teal2));transition:width .8s}
.owner-num{font-size:10px;font-weight:600;font-family:'DM Mono',monospace;width:26px;text-align:right;flex-shrink:0}
.owner-status-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.dot-active{background:var(--green)}
.dot-off{background:var(--red)}
.dot-leave{background:var(--orange)}

/* ‚îÄ‚îÄ BOTTOM ROW ‚îÄ‚îÄ */
.bot-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.tcard{background:var(--s1);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.tcard-head{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.tcard-title{font-size:12px;font-weight:700}
table{width:100%;border-collapse:collapse}
th{padding:8px 14px;font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--muted);font-family:'DM Mono',monospace;text-align:left;background:var(--s2);border-bottom:1px solid var(--border)}
td{padding:8px 14px;font-size:11px;border-bottom:1px solid rgba(30,53,80,.5);color:var(--text);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(46,134,171,.04)}
.tag{display:inline-flex;align-items:center;gap:3px;padding:1px 7px;border-radius:4px;font-size:9px;font-weight:600;font-family:'DM Mono',monospace}
.tag-inst{background:rgba(26,58,92,.5);color:var(--teal2);border:1px solid rgba(46,134,171,.3)}
.tag-dup{background:rgba(192,57,43,.15);color:#E74C3C;border:1px solid rgba(231,76,60,.2)}
.tag-active{background:rgba(26,156,91,.15);color:#2ECC71;border:1px solid rgba(46,204,113,.2)}
.tag-off{background:rgba(192,57,43,.1);color:#E74C3C;border:1px solid rgba(231,76,60,.15)}
.tag-leave{background:rgba(230,126,34,.1);color:#E67E22;border:1px solid rgba(230,126,34,.15)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.overlay.open{display:flex}
.modal{background:var(--s1);border:1px solid var(--border);border-radius:18px;width:620px;max-width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 30px 80px rgba(0,0,0,.6);animation:mIn .3s cubic-bezier(.4,0,.2,1)}
@keyframes mIn{from{opacity:0;transform:scale(.95) translateY(10px)}}
.modal-head{padding:24px 28px 0;position:sticky;top:0;background:var(--s1);z-index:1;border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:0}
.modal-title{font-size:17px;font-weight:700;margin-bottom:3px}
.modal-sub{font-size:11px;color:var(--muted)}
.modal-body{padding:20px 28px 28px}
.modal-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--s2);padding:4px;border-radius:10px;width:fit-content}
.mtab{padding:7px 16px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;border:none;font-family:'Space Grotesk',sans-serif;background:transparent;color:var(--muted);transition:all .2s}
.mtab.active{background:var(--teal);color:#fff}
.tab-pane{display:none}
.tab-pane.active{display:block}
.fg{margin-bottom:16px}
.flbl{font-size:10px;font-weight:600;color:var(--muted);letter-spacing:1px;text-transform:uppercase;font-family:'DM Mono',monospace;margin-bottom:6px;display:block}
.finp{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;transition:border-color .2s}
.finp:focus{border-color:var(--teal)}
.fhint{font-size:9px;color:var(--dim);margin-top:5px;line-height:1.5}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.divider{height:1px;background:var(--border);margin:16px 0}
.alert{padding:9px 13px;border-radius:8px;font-size:11px;margin-bottom:12px;display:none}
.alert.show{display:block}
.alert-err{background:rgba(192,57,43,.15);border:1px solid rgba(231,76,60,.3);color:#E74C3C}
.alert-ok{background:rgba(26,156,91,.15);border:1px solid rgba(46,204,113,.3);color:#2ECC71}
.mactions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.step-list{counter-reset:s}
.step{counter-increment:s;display:flex;gap:10px;align-items:flex-start;font-size:11px;color:var(--muted);margin-bottom:9px;line-height:1.5}
.step::before{content:counter(s);background:var(--teal);color:#fff;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;margin-top:1px}
.info-box{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:16px}
.info-title{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;font-family:'DM Mono',monospace;margin-bottom:10px}
code{background:var(--s3);padding:1px 5px;border-radius:3px;font-size:10px;font-family:'DM Mono',monospace}

/* member list in admin */
.member-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto;margin-bottom:10px}
.member-item{display:flex;align-items:center;gap:10px;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:8px 12px}
.member-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.member-name{font-size:12px;flex:1}
.member-inst{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace}
.member-status-sel{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:10px;padding:3px 7px;font-family:'Space Grotesk',sans-serif;cursor:pointer;outline:none}

/* config bar */
.cfg-bar{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:9px 14px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:10px;color:var(--muted)}
.cfg-url{flex:1;font-family:'DM Mono',monospace;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--dim)}
.cfg-bar.connected .cfg-url{color:var(--teal2)}

/* no-data */
.no-data{text-align:center;padding:30px;color:var(--dim);font-size:12px}

@media(max-width:900px){.bot-grid{grid-template-columns:1fr}.kpi-grid{grid-template-columns:repeat(2,1fr)}.tb-right{gap:6px}.filter-bar{display:none}}
@media(max-width:600px){.main{padding:12px}.kpi-grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOCK SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lockScreen">
  <div class="lock-card">
    <div class="lock-logo">üìä</div>
    <div class="lock-title">Data Capture Dashboard</div>
    <div class="lock-subtitle">ARUA RRH ¬∑ ARUA CITY ¬∑ ARUA DLG ¬∑ YUMBE RRH</div>
    <input class="lock-input" id="lockInput" type="password" placeholder="Enter passcode" maxlength="20" />
    <button class="lock-btn" onclick="tryUnlock()">Unlock Dashboard</button>
    <div class="lock-error" id="lockError"></div>
    <div class="lock-hint">Contact your dashboard admin for the access code</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="tb-left">
      <div class="logo-mark">üìä</div>
      <div>
        <div class="app-title">Data Capture Tracker</div>
        <div class="app-sub" id="appSub">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="tb-right">
      <!-- Filters -->
      <div class="filter-bar">
        <span class="filter-label">View:</span>
        <select class="filter-select" id="filterInst" onchange="applyFilters()">
          <option value="all">All Institutions</option>
        </select>
        <select class="filter-select" id="filterMember" onchange="applyFilters()">
          <option value="all">All Members</option>
        </select>
        <select class="filter-select" id="filterDate" onchange="applyFilters()">
          <option value="all">All Dates</option>
        </select>
      </div>

      <div class="sync-pill">
        <div class="sync-dot" id="syncDot"></div>
        <span id="syncLbl">Not connected</span>
      </div>
      <button class="btn btn-ghost" onclick="refreshData()">‚Ü∫</button>
      <button class="btn btn-primary" id="adminBtn" onclick="openAdmin()" style="display:none">‚öô Admin</button>
      <button class="btn btn-ghost" id="connectBtn" onclick="openConnect()" style="display:none">üîó Connect</button>
      <button class="btn btn-red" onclick="lockApp()" style="font-size:10px">üîí Lock</button>
    </div>
  </header>

  <div class="main">

    <!-- connect bar ‚Äî admin only -->
    <div class="cfg-bar" id="cfgBar" style="display:none">
      <span>üîó</span>
      <span class="cfg-url" id="cfgUrl">No Google Sheet connected ‚Äî click Connect to link live data</span>
      <button class="btn btn-ghost" style="padding:3px 9px;font-size:10px" onclick="openConnect()">Connect</button>
    </div>

    <!-- MODE TOGGLE -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
      <div class="mode-bar">
        <button class="mode-btn active" id="modeAll" onclick="setMode('global')">üåê Global</button>
        <button class="mode-btn" id="modeInst" onclick="setMode('institution')">üè• By Institution</button>
        <button class="mode-btn" id="modeMember" onclick="setMode('member')">üë§ By Member</button>
      </div>
      <div id="lastSync" style="font-size:10px;color:var(--dim);font-family:'DM Mono',monospace"></div>
    </div>

    <!-- KPI CARDS -->
    <div class="slabel">Key Metrics</div>
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- PROGRESS BARS -->
    <div class="slabel">Progress by Institution</div>
    <div class="prog-grid" id="progGrid"></div>

    <!-- BOTTOM ROW -->
    <div class="slabel">Activity & Alerts</div>
    <div class="bot-grid">
      <div class="tcard">
        <div class="tcard-head">
          <span class="tcard-title">üìÖ Recent Daily Entries</span>
          <span class="badge b-blue" id="entryCountBadge">‚Äî entries</span>
        </div>
        <div style="max-height:320px;overflow-y:auto">
          <table><thead><tr><th>Owner</th><th>Institution</th><th>Date</th><th>Count</th></tr></thead>
          <tbody id="entryTbody"></tbody></table>
        </div>
      </div>
      <div class="tcard">
        <div class="tcard-head">
          <span class="tcard-title">‚ö†Ô∏è Duplicate Captures</span>
          <span class="badge b-red" id="dupCountBadge">‚Äî flagged</span>
        </div>
        <div style="max-height:320px;overflow-y:auto">
          <table><thead><tr><th>Owner 1</th><th>Owner 2</th><th>Emp #</th><th>Date</th></tr></thead>
          <tbody id="dupTbody"></tbody></table>
        </div>
      </div>
    </div>

    <!-- TEAM STATUS -->
    <div class="slabel">Team Member Status</div>
    <div class="tcard" style="margin-bottom:24px">
      <div class="tcard-head">
        <span class="tcard-title">üë• Team Overview</span>
        <span id="teamSummaryBadge" class="badge b-green"></span>
      </div>
      <div style="overflow-x:auto">
        <table><thead><tr><th>Name</th><th>Institution</th><th>Status</th><th>Total Captured</th><th>Last Active</th><th>Duplicates</th></tr></thead>
        <tbody id="teamTbody"></tbody></table>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONNECT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="connectModal">
  <div class="modal" style="width:560px">
    <div class="modal-head">
      <div class="modal-title">üîó Connect Google Sheet</div>
      <div class="modal-sub">Link your published Google Sheet CSV to sync live data</div>
    </div>
    <div class="modal-body">
      <div class="alert alert-err" id="connErr"></div>
      <div class="alert alert-ok" id="connOk"></div>
      <div class="info-box">
        <div class="info-title">Setup Steps</div>
        <div class="step-list">
          <div class="step">In Google Sheets: <strong style="color:var(--text)">File ‚Üí Share ‚Üí Publish to web</strong></div>
          <div class="step">Select the <strong style="color:var(--text)">DAILY_STATS</strong> sheet ‚Üí Format: <strong style="color:var(--text)">CSV</strong> ‚Üí Publish ‚Üí copy URL</div>
          <div class="step">Also publish the <strong style="color:var(--text)">CONFIG</strong> sheet and <strong style="color:var(--text)">DUPLICATES</strong> sheet (separate URLs)</div>
          <div class="step">Paste the URLs below and click Connect</div>
        </div>
      </div>
      <div class="fg">
        <label class="flbl">DAILY_STATS Sheet CSV URL *</label>
        <input class="finp" id="urlStats" placeholder="https://docs.google.com/spreadsheets/d/.../pub?gid=...&output=csv" />
        <div class="fhint">Main data sheet ‚Äî required for live stats</div>
      </div>
      <div class="fg">
        <label class="flbl">CONFIG Sheet CSV URL (optional)</label>
        <input class="finp" id="urlConfig" placeholder="https://docs.google.com/spreadsheets/d/.../pub?gid=...&output=csv" />
        <div class="fhint">Pulls institution names, targets, and team member list</div>
      </div>
      <div class="fg">
        <label class="flbl">DUPLICATES Sheet CSV URL (optional)</label>
        <input class="finp" id="urlDups" placeholder="https://docs.google.com/spreadsheets/d/.../pub?gid=...&output=csv" />
      </div>
      <div class="fg">
        <label class="flbl">‚ö° Apps Script Web App URL (for writing data)</label>
        <input class="finp" id="urlScript" placeholder="https://script.google.com/macros/s/.../exec" />
        <div class="fhint">The URL you copied after deploying your Apps Script. This allows the Admin panel to write new entries directly into your Google Sheet.</div>
      </div>
      <div class="frow">
        <div class="fg" style="margin-bottom:0">
          <label class="flbl">Team Passcode</label>
          <input class="finp" id="cfgTeamPass" placeholder="ARUA2026" />
          <div class="fhint">What viewers enter to see the dashboard</div>
        </div>
        <div class="fg" style="margin-bottom:0">
          <label class="flbl">Admin Passcode</label>
          <input class="finp" id="cfgAdminPass" placeholder="ADMIN@2026" type="password" />
          <div class="fhint">Only you ‚Äî to access Admin panel</div>
        </div>
      </div>
      <div class="mactions">
        <button class="btn btn-ghost" onclick="closeModal('connectModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveConnect()">‚ö° Connect & Sync</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="adminModal">
  <div class="modal" style="width:680px">
    <div class="modal-head">
      <div class="modal-title">‚öô Admin Panel</div>
      <div class="modal-sub">Manage institutions, team members, and add daily stats</div>
    </div>
    <div class="modal-body">
      <div class="modal-tabs">
        <button class="mtab active" onclick="switchTab('tabStats')">üìã Add Stats</button>
        <button class="mtab" onclick="switchTab('tabMembers')">üë• Team Members</button>
        <button class="mtab" onclick="switchTab('tabInst')">üè• Institutions</button>
        <button class="mtab" onclick="switchTab('tabDups')">‚ö†Ô∏è Duplicates</button>
      </div>

      <div class="alert alert-err" id="adminErr"></div>
      <div class="alert alert-ok" id="adminOk"></div>

      <!-- TAB: Add Stats -->
      <div class="tab-pane active" id="tabStats">
        <div class="info-box" style="margin-bottom:14px">
          <div class="info-title">Note</div>
          <div style="font-size:11px;color:var(--muted)">Entries added here will be written to your Google Sheet via Apps Script. Make sure you have deployed the Apps Script (see Connect panel for setup).</div>
        </div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">Date *</label>
            <input class="finp" id="asDate" type="date" />
          </div>
          <div class="fg">
            <label class="flbl">Institution *</label>
            <select class="finp" id="asInst"></select>
          </div>
        </div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">Data Owner *</label>
            <select class="finp" id="asMember"></select>
          </div>
          <div class="fg">
            <label class="flbl">Files Captured *</label>
            <input class="finp" id="asCount" type="number" min="0" placeholder="0" />
          </div>
        </div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">On Duty?</label>
            <select class="finp" id="asDuty">
              <option value="YES">YES</option>
              <option value="NO">NO</option>
            </select>
          </div>
          <div class="fg">
            <label class="flbl">Notes (optional)</label>
            <input class="finp" id="asNotes" placeholder="Any notes‚Ä¶" />
          </div>
        </div>
        <div class="mactions">
          <button class="btn btn-ghost" onclick="closeModal('adminModal')">Cancel</button>
          <button class="btn btn-primary" onclick="submitStat()">‚ûï Add Entry</button>
        </div>
      </div>

      <!-- TAB: Team Members -->
      <div class="tab-pane" id="tabMembers">
        <div class="member-list" id="memberList"></div>
        <div class="divider"></div>
        <div style="font-size:11px;font-weight:700;color:var(--muted);margin-bottom:10px">ADD NEW MEMBER</div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">Full Name *</label>
            <input class="finp" id="nmFull" placeholder="e.g. John Doe" />
          </div>
          <div class="fg">
            <label class="flbl">Short Name</label>
            <input class="finp" id="nmShort" placeholder="e.g. John" />
          </div>
        </div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">Institution</label>
            <select class="finp" id="nmInst"></select>
          </div>
          <div class="fg">
            <label class="flbl">Phone (optional)</label>
            <input class="finp" id="nmPhone" placeholder="+256‚Ä¶" />
          </div>
        </div>
        <div class="mactions">
          <button class="btn btn-ghost" onclick="closeModal('adminModal')">Cancel</button>
          <button class="btn btn-primary" onclick="addMember()">‚ûï Add Member</button>
        </div>
      </div>

      <!-- TAB: Institutions -->
      <div class="tab-pane" id="tabInst">
        <div class="member-list" id="instList"></div>
        <div class="divider"></div>
        <div style="font-size:11px;font-weight:700;color:var(--muted);margin-bottom:10px">ADD NEW INSTITUTION / VOTE</div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">Institution Name *</label>
            <input class="finp" id="niName" placeholder="e.g. Koboko RRH" />
          </div>
          <div class="fg">
            <label class="flbl">Vote Code *</label>
            <input class="finp" id="niCode" placeholder="e.g. KOBOKO" />
          </div>
        </div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">File Target</label>
            <input class="finp" id="niTarget" type="number" placeholder="0" />
          </div>
          <div class="fg">
            <label class="flbl">Notes</label>
            <input class="finp" id="niNotes" placeholder="Description‚Ä¶" />
          </div>
        </div>
        <div class="mactions">
          <button class="btn btn-ghost" onclick="closeModal('adminModal')">Cancel</button>
          <button class="btn btn-primary" onclick="addInstitution()">‚ûï Add Institution</button>
        </div>
      </div>

      <!-- TAB: Duplicates -->
      <div class="tab-pane" id="tabDups">
        <div style="font-size:11px;color:var(--muted);margin-bottom:14px">Log any file captured by more than one person.</div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">Date *</label>
            <input class="finp" id="dpDate" type="date" />
          </div>
          <div class="fg">
            <label class="flbl">Employee Number *</label>
            <input class="finp" id="dpEmp" placeholder="000000000XXXXXX" />
          </div>
        </div>
        <div class="frow">
          <div class="fg">
            <label class="flbl">Owner 1 *</label>
            <select class="finp" id="dpOwner1"></select>
          </div>
          <div class="fg">
            <label class="flbl">Owner 2 *</label>
            <select class="finp" id="dpOwner2"></select>
          </div>
        </div>
        <div class="fg">
          <label class="flbl">Institution</label>
          <select class="finp" id="dpInst"></select>
        </div>
        <div class="mactions">
          <button class="btn btn-ghost" onclick="closeModal('adminModal')">Cancel</button>
          <button class="btn btn-primary" onclick="addDuplicate()">‚ûï Log Duplicate</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN GATE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="adminGate">
  <div class="modal" style="width:380px">
    <div class="modal-body" style="text-align:center;padding:36px 32px">
      <div style="font-size:32px;margin-bottom:12px">üîê</div>
      <div style="font-size:17px;font-weight:700;margin-bottom:6px">Admin Access</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:24px">Enter the admin passcode to continue</div>
      <input class="finp" id="adminPassInput" type="password" placeholder="Admin passcode" style="text-align:center;letter-spacing:3px;margin-bottom:10px" />
      <div class="lock-error" id="adminPassErr" style="margin-bottom:10px"></div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn btn-ghost" onclick="closeModal('adminGate')">Cancel</button>
        <button class="btn btn-gold" onclick="checkAdminPass()">Unlock Admin</button>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CFG = {};
try { CFG = JSON.parse(localStorage.getItem('dc_cfg') || '{}'); } catch(e){}

// ‚îÄ‚îÄ HARDCODED DEFAULTS (pre-configured by admin) ‚îÄ‚îÄ
const DEFAULTS = {
  urlStats:      'https://docs.google.com/spreadsheets/d/e/2PACX-1vRT318YUbN2yDLBAvnGmTO90CzrkHfPSHj_RAuFh1s-pN2YuDjOtYtbuttElr6pK4I4_IHlXWGuOFol/pub?gid=686195105&single=true&output=csv',
  urlConfig:     'https://docs.google.com/spreadsheets/d/e/2PACX-1vRT318YUbN2yDLBAvnGmTO90CzrkHfPSHj_RAuFh1s-pN2YuDjOtYtbuttElr6pK4I4_IHlXWGuOFol/pub?gid=1076946811&single=true&output=csv',
  urlDups:       '',
  appsScriptUrl: 'https://script.google.com/macros/s/AKfycbwt6dAbu1QzTlL_l5Qb5S7D6q51kg0UWKFqoLLIZo_PzH63zCYhy-Ku7r8H0Q0q0JI/exec',
  teamPass:      'ARUA2026',
  adminPass:     'ADMIN@2026',
};
// Merge: saved config overrides defaults, but defaults fill any gaps
CFG = Object.assign({}, DEFAULTS, CFG);

let RAW = {
  stats:[],
  config:{ institutions:[], members:[] },
  duplicates:[],
};
let FILTERED = { stats:[], mode:'global', inst:'all', member:'all', date:'all' };
let isAdmin = false;
let autoTimer = null;

// ‚îÄ‚îÄ PASSCODES (defaults, overridden by saved config) ‚îÄ‚îÄ
function teamPass(){ return CFG.teamPass || 'ARUA2026'; }
function adminPass(){ return CFG.adminPass || 'ADMIN@2026'; }

// ‚îÄ‚îÄ Apps Script Web App URL ‚îÄ‚îÄ
function appsScriptUrl(){ return CFG.appsScriptUrl || ''; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCK / UNLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tryUnlock(){
  const v = document.getElementById('lockInput').value.trim();
  const err = document.getElementById('lockError');
  if(v === teamPass() || v === adminPass()){
    if(v === adminPass()) isAdmin = true;
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    if(isAdmin){
      document.getElementById('adminBtn').style.display = 'flex';
      document.getElementById('connectBtn').style.display = 'flex';
      document.getElementById('cfgBar').style.display = 'flex';
    }
    initApp();
  } else {
    err.textContent = '‚úó Incorrect passcode. Try again.';
    document.getElementById('lockInput').value = '';
    setTimeout(()=>err.textContent='', 3000);
  }
}
document.getElementById('lockInput').addEventListener('keydown', e => { if(e.key==='Enter') tryUnlock(); });

function lockApp(){
  isAdmin = false;
  document.getElementById('lockInput').value = '';
  document.getElementById('lockError').textContent = '';
  document.getElementById('app').style.display = 'none';
  document.getElementById('lockScreen').style.display = 'flex';
  document.getElementById('adminBtn').style.display = 'none';
  document.getElementById('connectBtn').style.display = 'none';
  document.getElementById('cfgBar').style.display = 'none';
  stopAutoRefresh();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp(){
  // load defaults
  RAW.config.institutions = [
    {name:'Arua RRH',  code:'RRH',   target:249,  notes:'Regional Referral Hospital'},
    {name:'Arua City', code:'CITY',  target:2253, notes:'City Council'},
    {name:'Arua DLG',  code:'DLG',   target:0,    notes:'District Local Government'},
    {name:'Yumbe RRH', code:'YUMBE', target:0,    notes:'Yumbe Referral Hospital'},
  ];
  RAW.config.members = [
    {name:'Nicholas Mulaya', short:'Nicholas', status:'ACTIVE', inst:'Arua RRH'},
    {name:'Robinah Kasande', short:'Robinah',  status:'ACTIVE', inst:'Arua RRH'},
    {name:'Kalinda Fredrick',short:'Fredrick', status:'ACTIVE', inst:'Arua RRH'},
    {name:'Anthony Nyombi',  short:'Anthony',  status:'ACTIVE', inst:'Arua RRH'},
    {name:'Salim Kigundu',   short:'Salim',    status:'ACTIVE', inst:'Arua RRH'},
    {name:'Dilght Cotilda',  short:'Delight',  status:'ACTIVE', inst:'Arua RRH'},
    {name:'Ismail Matte',    short:'Ismail',   status:'ACTIVE', inst:'Arua RRH'},
  ];
  RAW.stats = [
    {date:'2026-02-17',inst:'Arua RRH',owner:'Nicholas Mulaya', count:0,  duty:'YES',notes:''},
    {date:'2026-02-18',inst:'Arua RRH',owner:'Nicholas Mulaya', count:38, duty:'YES',notes:''},
    {date:'2026-02-18',inst:'Arua RRH',owner:'Robinah Kasande', count:37, duty:'YES',notes:''},
    {date:'2026-02-18',inst:'Arua RRH',owner:'Kalinda Fredrick',count:44, duty:'YES',notes:''},
    {date:'2026-02-18',inst:'Arua RRH',owner:'Anthony Nyombi',  count:25, duty:'YES',notes:''},
    {date:'2026-02-18',inst:'Arua RRH',owner:'Salim Kigundu',   count:37, duty:'YES',notes:''},
    {date:'2026-02-18',inst:'Arua RRH',owner:'Dilght Cotilda',  count:22, duty:'YES',notes:''},
    {date:'2026-02-18',inst:'Arua RRH',owner:'Ismail Matte',    count:35, duty:'YES',notes:''},
    {date:'2026-02-19',inst:'Arua City',owner:'‚Äî',              count:0,  duty:'YES',notes:'First day'},
  ];
  RAW.duplicates = [
    {date:'2026-02-18',empNo:'...77339',owner1:'Robinah Kasande', owner2:'Anthony Nyombi',  inst:'Arua RRH'},
    {date:'2026-02-18',empNo:'...26818',owner1:'Robinah Kasande', owner2:'Salim Kigundu',   inst:'Arua RRH'},
    {date:'2026-02-18',empNo:'...27042',owner1:'Nicholas Mulaya', owner2:'Dilght Cotilda',  inst:'Arua RRH'},
    {date:'2026-02-18',empNo:'...27684',owner1:'Robinah Kasande', owner2:'Kalinda Fredrick',inst:'Arua RRH'},
    {date:'2026-02-18',empNo:'...56510',owner1:'Robinah Kasande', owner2:'Salim Kigundu',   inst:'Arua RRH'},
    {date:'2026-02-18',empNo:'...40530',owner1:'Robinah Kasande', owner2:'Dilght Cotilda',  inst:'Arua RRH'},
    {date:'2026-02-18',empNo:'...78371',owner1:'Kalinda Fredrick',owner2:'Dilght Cotilda',  inst:'Arua RRH'},
  ];

  populateFilters();
  applyFilters();

  // Always auto-fetch since URLs are pre-configured
  if(CFG.urlStats){
    document.getElementById('cfgBar').classList.add('connected');
    document.getElementById('cfgUrl').textContent = CFG.urlStats;
    fetchAll();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FETCH FROM GOOGLE SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROXIES = [
  url => url,
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
];

async function fetchCSV(rawUrl){
  for(const p of PROXIES){
    try{
      const r = await fetch(p(rawUrl), {cache:'no-store'});
      if(r.ok){ const t = await r.text(); if(t.length>10) return t; }
    }catch(e){}
  }
  return null;
}

function parseCSV(text){
  if(!text) return [];
  return text.trim().split('\n').map(line=>{
    const row=[]; let f=''; let q=false;
    for(const ch of line){
      if(ch==='"'){q=!q}
      else if(ch===','&&!q){row.push(f.trim());f=''}
      else f+=ch;
    }
    row.push(f.trim());
    return row;
  });
}

async function fetchAll(){
  setSyncStatus('loading');
  let ok = false;

  // Fetch DAILY_STATS
  if(CFG.urlStats){
    const csv = await fetchCSV(CFG.urlStats);
    if(csv){ parseStats(parseCSV(csv)); ok=true; }
  }

  // Fetch CONFIG
  if(CFG.urlConfig){
    const csv = await fetchCSV(CFG.urlConfig);
    if(csv) parseConfig(parseCSV(csv));
  }

  // Fetch DUPLICATES
  if(CFG.urlDups){
    const csv = await fetchCSV(CFG.urlDups);
    if(csv) parseDups(parseCSV(csv));
  }

  if(ok){
    setSyncStatus('live');
    document.getElementById('lastSync').textContent = 'Synced '+new Date().toLocaleTimeString();
    startAutoRefresh();
  } else {
    setSyncStatus('err');
    document.getElementById('lastSync').textContent = 'Sync failed ‚Äî showing demo data';
  }
  populateFilters();
  applyFilters();
}

function cleanDate(raw){
  if(!raw) return "";
  const s = String(raw).trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = s.match(/^(\d{4}-\d{2}-\d{2})[T ]/);
  if(m) return m[1];
  const slash = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(slash) return `${slash[3]}-${slash[2].padStart(2,"0")}-${slash[1].padStart(2,"0")}`;
  try{ const d=new Date(s); if(!isNaN(d)) return d.toISOString().split("T")[0]; }catch(e){}
  return s;
}

function parseStats(rows){
  if(!rows.length) return;
  // Find BEST header row ‚Äî must have both institution + owner columns
  let hi = -1;
  for(let i=0;i<Math.min(rows.length,10);i++){
    const r=rows[i].map(c=>String(c).toLowerCase().trim());
    if(r.some(c=>c.includes('institution'))&&r.some(c=>c.includes('owner'))){hi=i;break;}
  }
  if(hi<0) hi=rows.findIndex(r=>r.some(c=>String(c).toLowerCase().includes('date')));
  if(hi<0) hi=0;
  const hdr=rows[hi].map(c=>String(c).toLowerCase().trim());
  const iDate  = hdr.findIndex(h=>h.includes('date'));
  const iInst  = hdr.findIndex(h=>h.includes('institution'));
  const iOwner = hdr.findIndex(h=>h.includes('data owner')||h==='owner');
  const iCount = hdr.findIndex(h=>h.includes('files')||h.includes('captured'));
  const iDuty  = hdr.findIndex(h=>h.includes('duty'));
  const iNotes = hdr.findIndex(h=>h.includes('note'));
  console.log('Stats header row:',hi,'| date:',iDate,'inst:',iInst,'owner:',iOwner,'count:',iCount);
  const parsed=[];
  for(let i=hi+1;i<rows.length;i++){
    const r=rows[i];
    const inst  = iInst>=0  ? String(r[iInst] ||'').trim() : '';
    const owner = iOwner>=0 ? String(r[iOwner]||'').trim() : '';
    if(!inst||!owner) continue;
    if(inst.toLowerCase().includes('institution')) continue;
    if(inst.toLowerCase().includes('enter one')) continue;
    const cnt=parseFloat(iCount>=0?r[iCount]:0);
    if(isNaN(cnt)) continue;
    parsed.push({
      date:  cleanDate(iDate>=0?r[iDate]:''),
      inst:  inst,
      owner: owner,
      count: cnt,
      duty:  iDuty>=0  ? String(r[iDuty] ||'YES').trim() : 'YES',
      notes: iNotes>=0 ? String(r[iNotes]||'').trim()    : '',
    });
  }
  console.log('Parsed',parsed.length,'rows. Sample:', parsed.slice(0,3).map(r=>r.inst+'/'+r.owner+'/'+r.count));
  if(parsed.length) RAW.stats=parsed;
}

function parseConfig(rows){
  // Look for institution rows (rows with a number target)
  const insts=[], members=[];
  let memberSection=false;
  for(const r of rows){
    if(r[0]==='Institution Name'||r[0]==='Full Name') continue;
    if(r[0]&&r[2]&&!isNaN(r[2])){
      insts.push({name:r[0],code:r[1]||'',target:parseInt(r[2])||0,notes:r[3]||''});
    }
    if(r[0]&&r[2]&&isNaN(r[2])&&['ACTIVE','OFF','LEAVE','RESIGNED'].includes(r[2].toUpperCase())){
      members.push({name:r[0],short:r[1]||r[0].split(' ')[0],status:r[2].toUpperCase(),inst:r[3]||''});
    }
  }
  if(insts.length) RAW.config.institutions = insts;
  if(members.length) RAW.config.members = members;
}

function parseDups(rows){
  const hi = rows.findIndex(r=>r.some(c=>c.toLowerCase().includes('date')));
  if(hi<0) return;
  const hdr=rows[hi].map(c=>c.toLowerCase());
  const col=n=>hdr.indexOf(n);
  const dups=[];
  for(let i=hi+1;i<rows.length;i++){
    const r=rows[i];
    if(!r[col('employee number')]&&!r[2]) continue;
    dups.push({
      date:r[col('date')]||'',
      empNo:r[col('employee number')]||r[2]||'',
      owner1:r[col('owner 1')]||r[3]||'',
      owner2:r[col('owner 2')]||r[4]||'',
      inst:r[col('institution')]||r[5]||'',
    });
  }
  if(dups.length) RAW.duplicates=dups;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTERS & MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentMode = 'global';

function setMode(m){
  currentMode=m;
  ['modeAll','modeInst','modeMember'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(m==='global') document.getElementById('modeAll').classList.add('active');
  if(m==='institution') document.getElementById('modeInst').classList.add('active');
  if(m==='member') document.getElementById('modeMember').classList.add('active');
  applyFilters();
}

function populateFilters(){
  const insts=[...new Set(RAW.stats.map(s=>s.inst))].filter(Boolean);
  const members=[...new Set(RAW.stats.map(s=>s.owner))].filter(Boolean);
  const dates=[...new Set(RAW.stats.map(s=>s.date))].filter(Boolean).sort().reverse();

  const fi=document.getElementById('filterInst');
  const cur=fi.value;
  fi.innerHTML='<option value="all">All Institutions</option>';
  insts.forEach(i=>{ const o=document.createElement('option');o.value=i;o.textContent=i;fi.appendChild(o); });
  if(cur) fi.value=cur;

  const fm=document.getElementById('filterMember');
  const curm=fm.value;
  fm.innerHTML='<option value="all">All Members</option>';
  members.forEach(m=>{ const o=document.createElement('option');o.value=m;o.textContent=m;fm.appendChild(o); });
  if(curm) fm.value=curm;

  const fd=document.getElementById('filterDate');
  const curd=fd.value;
  fd.innerHTML='<option value="all">All Dates</option>';
  dates.forEach(d=>{ const o=document.createElement('option');o.value=d;o.textContent=d;fd.appendChild(o); });
  if(curd) fd.value=curd;

  // Admin selects
  populateAdminSelects();
}

function applyFilters(){
  const inst   = document.getElementById('filterInst').value;
  const member = document.getElementById('filterMember').value;
  const date   = document.getElementById('filterDate').value;

  let data = [...RAW.stats];
  if(inst!=='all')   data=data.filter(s=>s.inst===inst);
  if(member!=='all') data=data.filter(s=>s.owner===member);
  if(date!=='all')   data=data.filter(s=>s.date===date);

  FILTERED.stats=data;
  FILTERED.inst=inst;
  FILTERED.member=member;
  FILTERED.date=date;

  // subtitle
  let parts=[];
  if(inst!=='all') parts.push(inst);
  if(member!=='all') parts.push(member);
  if(date!=='all') parts.push(date);
  document.getElementById('appSub').textContent = parts.length ? parts.join(' ¬∑ ') : 'Global View ‚Äî All Institutions';

  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  renderKPIs();
  renderProgress();
  renderEntries();
  renderDuplicates();
  renderTeam();
}

function getInstStats(instName, data){
  const cfg = RAW.config.institutions.find(i=>i.name===instName)||{target:0};
  const captured = data.filter(s=>s.inst===instName).reduce((a,s)=>a+s.count,0);
  const target = cfg.target||0;
  return { target, captured, balance:Math.max(0,target-captured), pct:target>0?captured/target:0 };
}

function renderKPIs(){
  const g = document.getElementById('kpiGrid');
  g.innerHTML='';

  const data = FILTERED.stats;
  const allInsts = currentMode==='institution'&&FILTERED.inst!=='all'
    ? [FILTERED.inst]
    : [...new Set(RAW.config.institutions.map(i=>i.name))];

  // Grand totals
  const totalTarget = RAW.config.institutions.reduce((a,i)=>a+i.target,0);
  const totalCaptured = RAW.stats.reduce((a,s)=>a+s.count,0);
  const totalBalance = Math.max(0,totalTarget-totalCaptured);
  const totalPct = totalTarget>0?totalCaptured/totalTarget:0;
  const totalDups = RAW.duplicates.length;
  const activeMembers = RAW.config.members.filter(m=>m.status==='ACTIVE').length;

  const cards=[
    {icon:'üì¶',lbl:'Total Captured',val:totalCaptured.toLocaleString(),sub:`Target: ${totalTarget.toLocaleString()}`,ac:'--teal',pct:totalPct},
    {icon:'üìã',lbl:'Total Balance',val:totalBalance.toLocaleString(),sub:'Files remaining',ac:'--orange'},
    {icon:'üìà',lbl:'Overall Progress',val:(totalPct*100).toFixed(1)+'%',sub:'Across all institutions',ac:'--purple'},
    {icon:'‚ö†Ô∏è',lbl:'Duplicates Flagged',val:totalDups,sub:'Need resolution',ac:'--red'},
    {icon:'üë•',lbl:'Active Members',val:activeMembers,sub:`of ${RAW.config.members.length} total`,ac:'--green'},
  ];

  // Per-institution in institution mode
  if(currentMode==='institution'){
    const insts = FILTERED.inst==='all' ? RAW.config.institutions : RAW.config.institutions.filter(i=>i.name===FILTERED.inst);
    insts.forEach(inst=>{
      const s = getInstStats(inst.name, RAW.stats);
      cards.push({icon:'üè•',lbl:inst.name,val:s.captured.toLocaleString(),
        sub:`Target: ${s.target.toLocaleString()} ¬∑ Bal: ${s.balance}`,ac:'--teal',pct:s.pct,code:inst.code});
    });
  }

  cards.forEach(c=>{
    const pct = c.pct!==undefined?c.pct:null;
    const badgeClass = pct===null?'b-blue':pct>=1?'b-green':pct>=.75?'b-blue':pct>=.4?'b-orange':'b-red';
    const badgeTxt = pct===null?'':pct>=1?'‚úÖ Done':pct>=.75?`üîµ ${(pct*100).toFixed(0)}%`:`‚ö† ${(pct*100).toFixed(0)}%`;
    const div=document.createElement('div');
    div.className='kpi-card';
    div.style.setProperty('--ac',`var(${c.ac})`);
    div.innerHTML=`<div class="kpi-icon">${c.icon}</div><div class="kpi-lbl">${c.lbl}</div><div class="kpi-val">${c.val}</div><div class="kpi-sub">${c.sub}</div>${badgeTxt?`<span class="badge ${badgeClass}">${badgeTxt}</span>`:''}`;
    g.appendChild(div);
  });
}

function renderProgress(){
  const g=document.getElementById('progGrid');
  g.innerHTML='';
  const insts = FILTERED.inst!=='all'
    ? RAW.config.institutions.filter(i=>i.name===FILTERED.inst)
    : RAW.config.institutions;

  insts.forEach(inst=>{
    const s=getInstStats(inst.name, RAW.stats);
    const pct=Math.min(100,s.pct*100).toFixed(1);

    // Per-owner within this institution
    const ownerMap={};
    RAW.stats.filter(x=>x.inst===inst.name).forEach(x=>{
      ownerMap[x.owner]=(ownerMap[x.owner]||0)+x.count;
    });
    const owners=Object.entries(ownerMap).sort((a,b)=>b[1]-a[1]);
    const maxCount=owners.length?Math.max(...owners.map(o=>o[1])):1;

    const ownerBars=owners.slice(0,6).map(([name,cnt])=>{
      const pctO=(cnt/maxCount*100).toFixed(0);
      const mem=RAW.config.members.find(m=>m.name===name);
      const dotClass=mem?{ACTIVE:'dot-active',OFF:'dot-off',LEAVE:'dot-leave'}[mem.status]||'dot-off':'dot-active';
      return `<div class="owner-row">
        <div class="owner-status-dot ${dotClass}"></div>
        <span class="owner-name" title="${name}">${name.split(' ')[0]}</span>
        <div class="owner-track"><div class="owner-fill" style="width:${pctO}%"></div></div>
        <span class="owner-num">${cnt}</span>
      </div>`;
    }).join('');

    const fillColor = parseFloat(pct)>=100?'#1A9C5B':parseFloat(pct)>=75?'#2E86AB':parseFloat(pct)>=40?'#E67E22':'#C0392B';

    const div=document.createElement('div');
    div.className='prog-card';
    div.innerHTML=`
      <div class="prog-head">
        <div><div class="prog-name">üè• ${inst.name}</div>
          <div class="prog-sub">${inst.code} ¬∑ Target: ${s.target.toLocaleString()}</div></div>
        <div style="text-align:right"><div class="prog-pct">${pct}%</div>
          <div class="prog-pct-lbl">complete</div></div>
      </div>
      <div class="track"><div class="fill" style="width:${pct}%;background:linear-gradient(90deg,${fillColor},${fillColor}aa)"></div></div>
      <div class="prog-meta"><span>${s.captured.toLocaleString()} captured</span><span>${s.balance.toLocaleString()} remaining</span></div>
      ${ownerBars||'<div style="font-size:10px;color:var(--dim);margin-top:6px">No data yet for this institution</div>'}`;
    g.appendChild(div);
  });
}

function renderEntries(){
  const tb=document.getElementById('entryTbody');
  tb.innerHTML='';
  const data = [...FILTERED.stats].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,30);
  document.getElementById('entryCountBadge').textContent=data.length+' entries';
  if(!data.length){
    tb.innerHTML='<tr><td colspan="4" class="no-data">No entries match current filters</td></tr>';
    return;
  }
  data.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.owner}</td><td><span class="tag tag-inst">${e.inst}</span></td>
      <td style="font-family:'DM Mono',monospace;font-size:10px">${e.date}</td>
      <td style="font-weight:700;color:var(--teal2);font-family:'DM Mono',monospace">${e.count}</td>`;
    tb.appendChild(tr);
  });
}

function renderDuplicates(){
  const tb=document.getElementById('dupTbody');
  tb.innerHTML='';
  let dups=RAW.duplicates;
  if(FILTERED.inst!=='all') dups=dups.filter(d=>d.inst===FILTERED.inst);
  document.getElementById('dupCountBadge').textContent=dups.length+' flagged';
  if(!dups.length){
    tb.innerHTML='<tr><td colspan="4" class="no-data">No duplicates found üéâ</td></tr>';
    return;
  }
  dups.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${d.owner1}</td><td>${d.owner2}</td>
      <td style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)">${d.empNo}</td>
      <td style="font-family:'DM Mono',monospace;font-size:10px">${d.date}</td>`;
    tb.appendChild(tr);
  });
}

function renderTeam(){
  const tb=document.getElementById('teamTbody');
  tb.innerHTML='';
  let members=RAW.config.members;
  if(FILTERED.inst!=='all') members=members.filter(m=>m.inst===FILTERED.inst);
  if(FILTERED.member!=='all') members=members.filter(m=>m.name===FILTERED.member);

  const active=members.filter(m=>m.status==='ACTIVE').length;
  document.getElementById('teamSummaryBadge').textContent=`${active} active / ${members.length} total`;

  if(!members.length){ tb.innerHTML='<tr><td colspan="6" class="no-data">No members</td></tr>'; return; }

  members.forEach(m=>{
    const captured=RAW.stats.filter(s=>s.owner===m.name).reduce((a,s)=>a+s.count,0);
    const dates=RAW.stats.filter(s=>s.owner===m.name&&s.count>0).map(s=>s.date).sort();
    const lastDate=dates.length?dates[dates.length-1]:'‚Äî';
    const dups=RAW.duplicates.filter(d=>d.owner1===m.name||d.owner2===m.name).length;
    const statusMap={ACTIVE:'tag-active',OFF:'tag-off',LEAVE:'tag-leave'};
    const tagClass=statusMap[m.status]||'tag-off';

    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="font-weight:600">${m.name}</td>
      <td><span class="tag tag-inst">${m.inst}</span></td>
      <td><span class="tag ${tagClass}">${m.status}</span></td>
      <td style="font-weight:700;font-family:'DM Mono',monospace;color:var(--teal2)">${captured.toLocaleString()}</td>
      <td style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)">${lastDate}</td>
      <td style="font-family:'DM Mono',monospace;color:${dups>0?'#E74C3C':'var(--dim)'}">${dups>0?'‚ö† '+dups:'‚Äî'}</td>`;
    tb.appendChild(tr);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAdmin(){
  if(!isAdmin){
    document.getElementById('adminPassInput').value='';
    document.getElementById('adminPassErr').textContent='';
    openModal('adminGate');
  } else {
    populateAdminSelects();
    openModal('adminModal');
  }
}

function checkAdminPass(){
  const v=document.getElementById('adminPassInput').value.trim();
  if(v===adminPass()){
    isAdmin=true;
    closeModal('adminGate');
    populateAdminSelects();
    openModal('adminModal');
  } else {
    document.getElementById('adminPassErr').textContent='‚úó Incorrect admin passcode';
    setTimeout(()=>document.getElementById('adminPassErr').textContent='',2500);
  }
}

function populateAdminSelects(){
  const insts=RAW.config.institutions.map(i=>i.name);
  const members=RAW.config.members.map(m=>m.name);

  ['asInst','niCode','dpInst'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el||id==='niCode') return;
    const cur=el.value;
    el.innerHTML='<option value="">Select‚Ä¶</option>';
    insts.forEach(i=>{ const o=document.createElement('option');o.value=i;o.textContent=i;el.appendChild(o); });
    if(cur) el.value=cur;
  });
  ['asMember','dpOwner1','dpOwner2'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    const cur=el.value;
    el.innerHTML='<option value="">Select‚Ä¶</option>';
    members.forEach(m=>{ const o=document.createElement('option');o.value=m;o.textContent=m;el.appendChild(o); });
    if(cur) el.value=cur;
  });
  ['nmInst','dpInst'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.innerHTML='<option value="">Select‚Ä¶</option>';
    insts.forEach(i=>{ const o=document.createElement('option');o.value=i;o.textContent=i;el.appendChild(o); });
  });

  // Set today as default date
  const today=new Date().toISOString().split('T')[0];
  ['asDate','dpDate'].forEach(id=>{ const el=document.getElementById(id); if(el&&!el.value) el.value=today; });

  // Member list with status toggles
  const ml=document.getElementById('memberList');
  if(ml){
    ml.innerHTML='';
    RAW.config.members.forEach((m,idx)=>{
      const dotColor={ACTIVE:'#2ECC71',OFF:'#E74C3C',LEAVE:'#E67E22'}[m.status]||'#999';
      const div=document.createElement('div');
      div.className='member-item';
      div.innerHTML=`<div class="member-dot" style="background:${dotColor}"></div>
        <span class="member-name">${m.name}</span>
        <span class="member-inst">${m.inst}</span>
        <select class="member-status-sel" onchange="updateMemberStatus(${idx},this.value)">
          <option ${m.status==='ACTIVE'?'selected':''}>ACTIVE</option>
          <option ${m.status==='OFF'?'selected':''}>OFF</option>
          <option ${m.status==='LEAVE'?'selected':''}>LEAVE</option>
          <option ${m.status==='RESIGNED'?'selected':''}>RESIGNED</option>
        </select>`;
      ml.appendChild(div);
    });
  }

  // Institution list
  const il=document.getElementById('instList');
  if(il){
    il.innerHTML='';
    RAW.config.institutions.forEach((inst,idx)=>{
      const div=document.createElement('div');
      div.className='member-item';
      div.innerHTML=`<span style="font-size:16px">üè•</span>
        <span class="member-name">${inst.name}</span>
        <span class="member-inst">${inst.code}</span>
        <span style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace">Target: ${inst.target||'Not set'}</span>`;
      il.appendChild(div);
    });
  }
}

function switchTab(id){
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.mtab').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.target.classList.add('active');
}

function updateMemberStatus(idx,status){
  RAW.config.members[idx].status=status;
  render();
  writeToSheet('member_status',{name:RAW.config.members[idx].name,status});
}

async function submitStat(){
  const date=document.getElementById('asDate').value;
  const inst=document.getElementById('asInst').value;
  const owner=document.getElementById('asMember').value;
  const count=parseInt(document.getElementById('asCount').value)||0;
  const duty=document.getElementById('asDuty').value;
  const notes=document.getElementById('asNotes').value;

  if(!date||!inst||!owner){ showAdminMsg('err','Please fill in all required fields'); return; }

  const row={date,inst,owner,count,duty,notes};
  RAW.stats.push(row);
  FILTERED.stats=RAW.stats; // will be re-filtered
  populateFilters();
  applyFilters();

  const ok = await writeToSheet('add_stat',row);
  if(ok){
    showAdminMsg('ok',`‚úÖ Entry added: ${owner} ‚Äî ${count} files on ${date}`);
    document.getElementById('asCount').value='';
    document.getElementById('asNotes').value='';
  } else {
    showAdminMsg('ok',`‚úÖ Entry added locally. ${appsScriptUrl()?'Sheet write pending.':'Connect Apps Script to sync to sheet.'}`);
  }
}

function addMember(){
  const full=document.getElementById('nmFull').value.trim();
  const short=document.getElementById('nmShort').value.trim()||full.split(' ')[0];
  const inst=document.getElementById('nmInst').value;
  const phone=document.getElementById('nmPhone').value.trim();
  if(!full){ showAdminMsg('err','Full name is required'); return; }
  RAW.config.members.push({name:full,short,status:'ACTIVE',inst,phone});
  populateAdminSelects();
  populateFilters();
  applyFilters();
  writeToSheet('add_member',{full,short,inst,phone,status:'ACTIVE'});
  showAdminMsg('ok',`‚úÖ Member added: ${full}`);
  document.getElementById('nmFull').value='';
  document.getElementById('nmShort').value='';
  document.getElementById('nmPhone').value='';
}

function addInstitution(){
  const name=document.getElementById('niName').value.trim();
  const code=document.getElementById('niCode').value.trim().toUpperCase();
  const target=parseInt(document.getElementById('niTarget').value)||0;
  const notes=document.getElementById('niNotes').value.trim();
  if(!name||!code){ showAdminMsg('err','Name and code are required'); return; }
  RAW.config.institutions.push({name,code,target,notes});
  populateAdminSelects();
  populateFilters();
  applyFilters();
  writeToSheet('add_institution',{name,code,target,notes});
  showAdminMsg('ok',`‚úÖ Institution added: ${name} (${code})`);
  ['niName','niCode','niTarget','niNotes'].forEach(id=>document.getElementById(id).value='');
}

function addDuplicate(){
  const date=document.getElementById('dpDate').value;
  const empNo=document.getElementById('dpEmp').value.trim();
  const owner1=document.getElementById('dpOwner1').value;
  const owner2=document.getElementById('dpOwner2').value;
  const inst=document.getElementById('dpInst').value;
  if(!empNo||!owner1||!owner2){ showAdminMsg('err','Employee number and both owners are required'); return; }
  RAW.duplicates.push({date,empNo,owner1,owner2,inst});
  renderDuplicates();
  writeToSheet('add_duplicate',{date,empNo,owner1,owner2,inst});
  showAdminMsg('ok',`‚úÖ Duplicate logged: ${owner1} / ${owner2}`);
  document.getElementById('dpEmp').value='';
}

function showAdminMsg(type,msg){
  const e=document.getElementById('adminErr');
  const o=document.getElementById('adminOk');
  e.classList.remove('show'); o.classList.remove('show');
  if(type==='err'){e.textContent=msg;e.classList.add('show');}
  else{o.textContent=msg;o.classList.add('show');}
  setTimeout(()=>{e.classList.remove('show');o.classList.remove('show');},4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WRITE TO GOOGLE SHEET (via Apps Script)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function writeToSheet(action, data){
  const url = appsScriptUrl();
  if(!url) return false;
  try{
    const resp = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action, data, adminKey: adminPass()}),
    });
    return resp.ok;
  }catch(e){ return false; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONNECT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openConnect(){
  document.getElementById('urlStats').value  = CFG.urlStats||'';
  document.getElementById('urlConfig').value = CFG.urlConfig||'';
  document.getElementById('urlDups').value   = CFG.urlDups||'';
  document.getElementById('urlScript').value = CFG.appsScriptUrl||'';
  document.getElementById('cfgTeamPass').value  = CFG.teamPass||'ARUA2026';
  document.getElementById('cfgAdminPass').value = CFG.adminPass||'';
  document.getElementById('connErr').classList.remove('show');
  document.getElementById('connOk').classList.remove('show');
  openModal('connectModal');
}

function saveConnect(){
  const stats  = document.getElementById('urlStats').value.trim();
  const config = document.getElementById('urlConfig').value.trim();
  const dups   = document.getElementById('urlDups').value.trim();
  const script = document.getElementById('urlScript').value.trim();
  const tPass  = document.getElementById('cfgTeamPass').value.trim();
  const aPass  = document.getElementById('cfgAdminPass').value.trim();

  CFG.urlStats      = stats;
  CFG.urlConfig     = config;
  CFG.urlDups       = dups;
  CFG.appsScriptUrl = script;
  if(tPass) CFG.teamPass  = tPass;
  if(aPass) CFG.adminPass = aPass;

  try{ localStorage.setItem('dc_cfg', JSON.stringify(CFG)); }catch(e){}

  document.getElementById('connOk').textContent='‚úÖ Saved! Fetching data‚Ä¶';
  document.getElementById('connOk').classList.add('show');

  if(stats){
    document.getElementById('cfgBar').classList.add('connected');
    document.getElementById('cfgUrl').textContent=stats;
    setTimeout(()=>{ closeModal('connectModal'); fetchAll(); },600);
  } else {
    setTimeout(()=>closeModal('connectModal'),600);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYNC STATUS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSyncStatus(s){
  const dot=document.getElementById('syncDot');
  const lbl=document.getElementById('syncLbl');
  dot.className='sync-dot';
  if(s==='live'){dot.classList.add('live');lbl.textContent='Live sync';}
  else if(s==='loading'){dot.classList.add('loading');lbl.textContent='Syncing‚Ä¶';}
  else if(s==='err'){dot.classList.add('err');lbl.textContent='Sync error';}
  else lbl.textContent='Not connected';
}

async function refreshData(){
  if(CFG.urlStats) await fetchAll();
  else{ populateFilters(); applyFilters(); }
}

function startAutoRefresh(){
  stopAutoRefresh();
  autoTimer=setInterval(()=>{ if(CFG.urlStats) fetchAll(); },2*60*1000);
}
function stopAutoRefresh(){ if(autoTimer){clearInterval(autoTimer);autoTimer=null;} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(el=>{
  el.addEventListener('click',e=>{ if(e.target===el) el.classList.remove('open'); });
});
</script>
</body>
</html>
